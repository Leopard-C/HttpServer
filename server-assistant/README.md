
# server-controller.py

## 1. 说明

按照指定的格式书写控制器，然后由该脚本生成路由注册代码。

## 2. 通用项目结构(示例)

```shell
project
├── script   # 辅助脚本
│   │   ├── server-assistant.bat
│   │   ├── server-assistant.sh
│   │   └── server-assistant.py
└── src
    ├── controller     # 控制器
    │   ├── server
    │   │   ├── server_controller.cpp
    │   │   └── server_controller.h
    │   ├── user
    │   │   ├── user_controller.cpp
    │   │   └── user_controller.h
    │   └── web
    │       ├── web_controller.cpp
    │       └── web_controller.h
    ├── main.cpp
    ├── routes.cpp   # 路由注册，由脚本 server-assistant.py 生成
    └── routes.h
 ```

## 3. Controller控制器书写规范

`controller`目录下有多个控制器文件，如用户控制器、web控制器等等，里面有多个方法，用于处理用户请求。

以 `controller/user/user_controller.h` 为例：

```cpp
#pragma once
#include <server/request.h>
#include <server/response.h>

namespace controller {

using namespace ic::server;

/**
 * @brief 用户控制器.
 */
class UserController {
public:
    /**
     * @brief 登录.
     * 
     * @route  /api/User/Login
     * @method POST
     * @config Authorization(0)
     * @config AdminOnly(0)
     */
    static void Login(Request& req, Response& res);

    /**
     * @brief 获取用户主页信息.
     * 
     * @note 正则表达式 ([a-zA-Z_][a-zA-Z0-9_]*) 用于匹配用户名
     * 
     * @route  ~ /api/User/space/([a-zA-Z_][a-zA-Z0-9_]*)
     * @method GET, POST
     * @config Authorization(1)
     */
    static void UserSpace(Request& req, Response& res);
};

} // namespace controller
```

除了 `类的静态成员函数`，普通的 `函数` 也可以使用，如：

```cpp
#pragma once
#include <server/request.h>
#include <server/response.h>

/**
 * @brief 登录.
 * 
 * @route  /api/User/Login
 * @method POST
 * @config Authorization(0)
 * @config AdminOnly(0)
 */
void Login(Request& req, Response& res);
```

每个控制器方法前面使用 `doxygen` 风格的注释，在原有的`@brief`, `@details`等标记的基础上，扩充了如下3个标记：

+ `@route`: 路由地址。
+ `@method`: 请求方法，支持 `GET`,`POST`,`OPTIONS`,`HEAD` 等多种HTTP请求。
+ `@config`: 自定义配置，格式为 `配置项名称(值)`。

以上3个标记<font color="red">均可以出现多次</font>。

### 3.1 `@route`

支持两种路由，`静态(固定)路由` 和 `正则路由`。

`静态路由`，即路由地址为固定的字符串，如示例中的 `Login` 方法。

`正则路由`，即路由地址中含有正则表达式，需要在 `@route` 之后添加 `~`，如示例中的 `UserSpace` 方法

### 3.2 `@method`

支持`GET`, `HEAD`, `POST`, `PUT`, `DELETE`, `CONNECT, OPTIONS`, `TRACE`, `PATCH` 这9种HTTP请求。

如果控制器方法支持多种HTTP请求，使用逗号分隔。如示例种的 `UserSpace` 方法。

### 3.3 `@config`

自定义配置，格式 `配置项名称(值)`，如示例种的 `@config Authorization(0)` 用于配置该路由是否需要token认证。（登录方法无需认证，其他方法一般需要认证）


## 4. 运行脚本

安装 `robotpy-cppheaderparser` 库，用于解析`c++`头文件。

```
pip3 install robotpy-cppheaderparser
```

命令格式：

```shell
./server-assistant.py parse-controller {controller_dir} {output_file} [-p {include_file_prefix}]
```

+ `{controller_dir}`: 输入`controler`控制器目录。
+ `{output_file}`: 输出的文件。
+ `-p {include_file_prefix}`: 生成的代码中，包含`controller`目录中的头文件时的前缀。

生成的 `routes.cpp` 文件如下：

```cpp
// Generated by script server-assistant.py
#include <server/router.h>
#include "controller/user/user_controller.h"

bool register_routes(std::shared_ptr<ic::server::Router> router) {
    using namespace ic::server;
    bool ret = true;

    // controller/user/user_controller.h
    ret &= router->AddStaticRoute("/api/User/Login", HttpMethod::kPOST, controller::UserController::Login, "登录.", {{"Authorization", "0"}, {"AdminOnly", "0"}});
    ret &= router->AddRegexRoute("/api/User/space/([a-zA-Z_][a-zA-Z0-9_]*)", HttpMethod::kGET | HttpMethod::kPOST, controller::UserController::UserSpace, "获取用户主页信息.", {{"Authorization", "1"}});

    return ret;
}
```

在项目代码中，初始化 `HttpServer`之后，调用 `register_routes(router)` 函数即可注册路由。

```cpp
// ...
auto svr = new HttpServer(...);

// ...

// 注册路由
if (!register_routes(svr->router())) {
    LError("注册路由失败！");
    return -1;
}

// ...

// 启动HTTP服务器
svr->Start();
```

## END

